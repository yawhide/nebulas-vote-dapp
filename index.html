<!doctype html>
<html>
    <head>
        <meta charset=utf-8>
        <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
        <title>Mock ontario election</title>
        <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.1/css/bootstrap.min.css" integrity="sha384-WskhaSGFgHYWDcbwN70/dfYBj47jz9qbsMId/iRN3ewGhXQFZCSftd1LZCfmhktB" crossorigin="anonymous">
        <link rel="stylesheet" type="text/css" href="css/style.css">
        <script src=js/jquery-3.3.1.min.js></script>
        <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.1.1/js/bootstrap.min.js" integrity="sha384-smHYKdLADwkXOn1EmN1qk/HfnUcbVRZyYmZ4qpPea6sjB/pTJ0euyQp0Mk8ck+5T" crossorigin="anonymous"></script>
        <script src="nebPay.js"></script>
    </head>
    <body>
        <nav class="navbar sticky-top navbar-expand-lg navbar-light bg-light">
            <div class="container">
                <span class="navbar-brand mb-0 h1">Mock ontario election</span>
                <ul class="navbar-nav mr-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="/nebulas-vote-dapp">Home</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/nebulas-vote-dapp/about.html">About</a>
                    </li>
                </ul>
            </div>
        </nav>
        <div class="container">
            <h4>Voting Booth</h4>
            <form class="form-inline">
                <div class="form-group mb-2">
                    <label for="staticEmail2" class="sr-only">Email</label>
                    <input id="vote" type="text" readonly class="form-control-plaintext" id="staticEmail2" value="You have voted for...">
                </div>
                <div class="form-group mx-sm-3 mb-2">
                    <select id="select" class="form-control">
                        <option></option>
                    </select>
                </div>
                <button id="votebtc" class="btn btn-primary mb-2" disabled onclick="javascript:onClickVote()">Vote</button>
            </form>
            <h4>Current Standings</h4>
            <table class="table">
                <thead>
                    <tr>
                        <th></th>
                        <th>Candidate</th>
                        <th>Votes</th>
                    </tr>
                </thead>
                <tbody id="tbody">
                </tbody>
            </table>
        </div>
        <script>
            "use strict";
            var NebPay = require('nebpay');
            var nebPay = new NebPay();

            // var contractAddress = 'n1tMib1B6gXBtgevvpWC5FqA98CjEG232Mn';
            // var callbackUrl = NebPay.config.mainnetUrl;
            // testnet
            var contractAddress = 'n1uGJ8rHX1tarzcGin3tLALYKrUckWf89bJ';
            var callbackUrl = NebPay.config.testnetUrl;
            var candidatePicMapping = {
                pc: 'img/pc.jpg',
                ndp: 'img/ndp.png',
                lib: 'img/lib.jpg',
            }

            $('#select').change(function () {
                $('#votebtc').prop('disabled', !this.value || this.value === 'Select candidate')
            });

            function onGetVotes(resp) {
                var candidateMapping = JSON.parse(resp.result);
                if(candidateMapping) {
                    var tbodyHtml = '';
                    var optionsHtml = '<option value="" selected disabled>Select candidate</option>';
                    Object.keys(candidateMapping).forEach(function (candidate) {
                        var tbody = '<tr>' +
                            '<td><img src="' + candidatePicMapping[candidate] + '" width="120" height="150" data-file-width="480" data-file-height="600"></td>' +
                            '<td>' + candidate + '</td>' +
                            '<td>' + candidateMapping[candidate] + '</td>' +
                            '</tr>';
                        tbodyHtml += tbody;
                        optionsHtml += '<option>' + candidate + '</option>';
                    });
                    $('#tbody').empty().append(tbodyHtml);
                    $('#select').empty().append(optionsHtml);
                    $('#votebtc').prop('disabled', true);
                }
                nebPay.simulateCall(contractAddress, 0, 'getMyVote', null, {
                    // callback: callback,
                    listener: function (resp) {
                        var candidate = JSON.parse(resp.result);
                        $('#vote').prop('value', 'You have voted for: ' + candidate);
                    },
                });
            }

            function onClickRefresh() {
                nebPay.simulateCall(contractAddress, 0, 'getVotes', null, {
                    // callback: callback,
                    listener: onGetVotes,
                });
            }

            function onCastVote(resp) {
                var response = JSON.parse(resp.result);
                console.log('response:', response, resp)
                debugger;
                // window.location.href = '/vote.html?tx=' + response;
            }

            function onClickVote() {
                var party = $('#select').val();
                nebPay.call(contractAddress, 0, 'castVote', JSON.stringify([party]), {
                    // callback: callbackUrl,
                    listener: onCastVote,
                });
            }

            if (typeof(webExtensionWallet) === 'undefined') {
                alert('Extension wallet is not installed, please install it first.');
                // window.location.href = '/nebulas-vote-dapp/about.html';
                var href = window.location.href;
                var dir = href.substring(0, href.lastIndexOf('/')) + '/';
                window.location =  dir + 'about.html';
            } else {
                onClickRefresh();
            }
        </script>
    </body>
</html>
