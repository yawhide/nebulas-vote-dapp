<!doctype html>
<html>
    <head>
        <meta charset=utf-8>
        <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
        <title>Mock ontario election</title>
        <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css" integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm" crossorigin="anonymous">
        <link rel="stylesheet" type="text/css" href="css/style.css">
    </head>
    <body>
        <nav class="navbar sticky-top navbar-expand-lg navbar-light bg-light">
            <div class="container">
                <span class="navbar-brand mb-0 h1">Mock ontario election</span>
                <ul class="navbar-nav mr-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="https://en.wikipedia.org/wiki/Ontario_general_election,_2018" target="_default">Election info</a>
                    </li>
                    <li class="nav-item">
                        <a id="refresh" class="nav-link" href="#" onclick="javascript:onClickRefresh()">Refresh</a>
                    </li>
                    <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle" href="#" id="navbarDropdown" role="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                            How to vote
                        </a>
                        <div class="dropdown-menu" aria-labelledby="navbarDropdown">
                            <a class="dropdown-item" href="https://github.com/ChengOrangeJu/WebExtensionWallet" target="_default">1. Ensure you have setup the WebExtensionWallet chrome extension</a>
                            <a class="dropdown-item" href="#">2. Click the dropdown "Select candidate"</a>
                            <a class="dropdown-item" href="#">3. Click vote</a>
                            <a class="dropdown-item" href="#">4. (optional) Click refresh until you see your vote go through to the blockchain</a>
                        </div>
                    </li>
                    <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle" href="#" id="navbarDropdown" role="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                            Mainnet
                        </a>
                        <div class="dropdown-menu" aria-labelledby="navbarDropdown">
                            <a id="mainnet" class="dropdown-item" href="#">Mainnet</a>
                            <a id="testnet" class="dropdown-item" href="#">Testnet</a>
                        </div>
                    </li>
                </ul>
            </div>
        </nav>
        <div class="container">
            <h4>Voting Booth</h4>
            <form class="form-inline">
                <div class="form-group mb-2">
                    <label for="staticEmail2" class="sr-only">Email</label>
                    <input id="vote" type="text" readonly class="form-control-plaintext" id="staticEmail2" value="You have voted for...">
                </div>
                <div class="form-group mx-sm-3 mb-2">
                    <select id="select" class="form-control">
                        <option></option>
                    </select>
                </div>
                <button id="votebtc" class="btn btn-primary mb-2" disabled onclick="javascript:onClickVote()">Vote</button>
            </form>
            <h4>Current Standings</h4>
            <table class="table">
                <thead>
                    <tr>
                        <th></th>
                        <th>Candidate</th>
                        <th>Votes</th>
                    </tr>
                </thead>
                <tbody id="tbody">
                </tbody>
            </table>
        </div>
        <!-- All of these scripts are dependancies from the Nebulas Web Wallet -->
        <script src=js/jquery-3.3.1.min.js></script>
        <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/js/bootstrap.min.js" integrity="sha384-JZR6Spejh4U02d8jOt6vLEHfe/JQGiRRSQQxSfFWpi1MquVdAyjUar5+76PVCmYl" crossorigin="anonymous"></script>
        <script src=nebPay.js></script>
        <!-- Front end logic for our Dapp -->
        <script>
            "use strict";
            var NebPay = require('nebpay');
            var nebPay = new NebPay();
            //to check if the extension is installed
            //if the extension is installed, var "webExtensionWallet" will be injected in to web page
            if(typeof(webExtensionWallet) === 'undefined'){
                alert ('Extension wallet is not installed, please install it first.')
            }

            var contractAddress = 'n1tMib1B6gXBtgevvpWC5FqA98CjEG232Mn';
            var callbackUrl;
            var candidatePicMapping = {
                pc: 'img/pc.jpg',
                ndp: 'img/ndp.png',
                lib: 'img/lib.jpg',
            }

            updateNebPayConfig();

            function isMainNet() {
                return contractAddress === 'n1tMib1B6gXBtgevvpWC5FqA98CjEG232Mn' ? 'mainnet' : 'testnet';
            }

            function updateNebPayConfig() {
                if (isMainNet() === 'mainnet') {
                    callbackUrl = NebPay.config.mainnetUrl;
                } else {
                    callbackUrl = NebPay.config.testnetUrl;
                }
            }

            $('#select').change(function () {
                $('#votebtc').prop('disabled', !this.value || this.value === 'Select candidate')
            });

            $('#mainnet').click(function () {
                $('nav-link dropdown-toggle').text('mainnet');
                var prevNet = isMainNet();
                contractAddress = 'n1tMib1B6gXBtgevvpWC5FqA98CjEG232Mn';
                console.log('changed from ' + prevNet + ' to ' + isMainNet());
                updateNebPayConfig();
                onClickRefresh();
            });

            $('#testnet').click(function () {
                $('nav-link dropdown-toggle').text('testnet');
                var prevNet = isMainNet();
                contractAddress = 'n1uGJ8rHX1tarzcGin3tLALYKrUckWf89bJ';
                console.log('changed from ' + prevNet + ' to ' + isMainNet());
                updateNebPayConfig();
                onClickRefresh();
            });

            function onGetVotes(resp) {
                var candidateMapping = JSON.parse(resp.result);
                if(candidateMapping) {
                    var tbodyHtml = '';
                    var optionsHtml = '<option value="" selected disabled>Select candidate</option>';
                    Object.keys(candidateMapping).forEach(function (candidate) {
                        var tbody = '<tr>' +
                            '<td><img src="' + candidatePicMapping[candidate] + '" width="120" height="150" data-file-width="480" data-file-height="600"></td>' +
                            '<td>' + candidate + '</td>' +
                            '<td>' + candidateMapping[candidate] + '</td>' +
                            '</tr>';
                        tbodyHtml += tbody;
                        optionsHtml += '<option>' + candidate + '</option>';
                    });
                    $('#tbody').empty().append(tbodyHtml);
                    $('#select').empty().append(optionsHtml);
                    $('#votebtc').prop('disabled', true);
                }
                nebPay.simulateCall(contractAddress, 0, 'getMyVote', null, {
                    // callback: callback,
                    listener: function (resp) {
                        var candidate = JSON.parse(resp.result);
                        $('#vote').prop('value', 'You have voted for: ' + candidate);
                    },
                });
            }

            function onClickRefresh() {
                nebPay.simulateCall(contractAddress, 0, 'getVotes', null, {
                    // callback: callback,
                    listener: onGetVotes,
                });
            }

            function onCastVote(resp) {
                onClickRefresh();
            }

            function onClickVote() {
                var party = $('#select').val();
                nebPay.call(contractAddress, 0, 'castVote', JSON.stringify([party]), {
                    // callback: callbackUrl,
                    listener: onCastVote,
                });
            }

            onClickRefresh();
        </script>
    </body>
</html>
