<!doctype html>
<html>
    <head>
        <meta charset=utf-8>
        <title>Mock ontario election</title>
    </head>
    <body>
        <select id="mainnet">
            <option value="n1uGJ8rHX1tarzcGin3tLALYKrUckWf89bJ">testnet</option>
            <option selected value="n1tMib1B6gXBtgevvpWC5FqA98CjEG232Mn">mainnet</option>
        </select>
        <div style="border-style: solid; margin: 20px 0 20px 0">
            <h4>2018 Ontario Election</h4>
            <a href="https://en.wikipedia.org/wiki/Ontario_general_election,_2018" target="_default">More infomation about the election</a>
            <h4>How to vote</h4>
            <ol>
                <li>Click the dropdown "Select candidate"</li>
                <li>Click vote</li>
                <li>(optional) Click refresh until you see your vote go through to the blockchain</li>
            </ol>
        </div>
        <div id="main">
            <table>
                <thead>
                    <tr>
                        <th>Candidate</th>
                        <th>Votes</th>
                    </tr>
                </thead>
                <tbody id="tbody">
                </tbody>
            </table>
            <h4>Voting Booth</h4>
            <p id="vote">You have voted for... You have to install the wallet chrome extension first!</p>
            <select id="select">
                <option></option>
            </select>
            <button id="votebtc" disabled onclick="javascript:onClickVote()">Vote</button>
            <button id="refresh" onclick="javascript:onClickRefresh()">Refresh</button>
        </div>
        <div id="loading">
            <p>Casting vote...</p>
        </div>

        <!-- All of these scripts are dependancies from the Nebulas Web Wallet -->
        <script src=js/jquery-3.3.1.min.js></script>
        <script src=nebPay.js></script>
        <!-- Front end logic for our Dapp -->
        <script>
            "use strict";
            var NebPay = require('nebpay');
            var nebPay = new NebPay();
            //to check if the extension is installed
            //if the extension is installed, var "webExtensionWallet" will be injected in to web page
            if(typeof(webExtensionWallet) === 'undefined'){
                alert ('Extension wallet is not installed, please install it first.')
            }

            var contractAddress = $('#mainnet').val();
            var callbackUrl;

            updateNebPayConfig();

            function isMainNet() {
                return contractAddress === 'n1tMib1B6gXBtgevvpWC5FqA98CjEG232Mn' ? 'mainnet' : 'testnet';
            }

            function updateNebPayConfig() {
                if (isMainNet() === 'mainnet') {
                    callbackUrl = NebPay.config.mainnetUrl;
                } else {
                    callbackUrl = NebPay.config.testnetUrl;
                }
            }

            $('#mainnet').change(function () {
                var prevNet = isMainNet();
                contractAddress = this.value;
                console.log('changed from ' + prevNet + ' to ' + isMainNet());
                updateNebPayConfig();
                onClickRefresh();
            });

            $('#select').change(function () {
                $('#votebtc').prop('disabled', !this.value || this.value === 'Select candidate')
            });

            function onGetVotes(resp) {
                var candidateMapping = JSON.parse(resp.result);
                if(candidateMapping) {
                    var tbodyHtml = '';
                    var optionsHtml = '<option value="" selected disabled>Select candidate</option>';
                    Object.keys(candidateMapping).forEach(function (candidate) {
                        var tbody = '<tr>' +
                            '<td>' + candidate + '</td>' +
                            '<td>' + candidateMapping[candidate] + '</td>' +
                            '</tr>';
                        tbodyHtml += tbody;
                        optionsHtml += '<option>' + candidate + '</option>';
                    });
                    $('#tbody').empty().append(tbodyHtml);
                    $('#select').empty().append(optionsHtml);
                    $('#votebtc').prop('disabled', true);
                }
                nebPay.simulateCall(contractAddress, 0, 'getMyVote', null, {
                    // callback: callback,
                    listener: function (resp) {
                        var candidate = JSON.parse(resp.result);
                        $('#vote').empty().append('You have voted for: ' + candidate);
                        $('#loading').hide();
                    },
                });
            }

            function onClickRefresh() {
                nebPay.simulateCall(contractAddress, 0, 'getVotes', null, {
                    // callback: callback,
                    listener: onGetVotes,
                });
            }

            function onCastVote(resp) {
                onClickRefresh();
                $('#loading').hide();
                $('#main').show();
            }

            function onClickVote() {
                $('#loading').show();
                $('#main').hide();
                var party = $('#select').val();
                nebPay.call(contractAddress, 0, 'castVote', JSON.stringify([party]), {
                    // callback: callbackUrl,
                    listener: onCastVote,
                });
            }

            onClickRefresh();
        </script>
    </body>
</html>
