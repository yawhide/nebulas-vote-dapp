<!doctype html>
<html>
    <head>
        <meta charset=utf-8>
        <title>Mock ontario election</title>
        <link rel=stylesheet href=css/ui-block.css>
    </head>
    <body>
        <!-- This pulls in the 'Select Wallet File' (incl Password) from Neb's library -->
        <div class=select-wallet-file></div>

        <br><br>

        <!-- The Dapp form -->
        <div id="main">
            <h4>2018 Ontario Election</h4>
            <table>
                <thead>
                    <tr>
                        <th>Candidate</th>
                        <th>Votes</th>
                    </tr>
                </thead>
                <tbody id="tbody">
                </tbody>
            </table>
            <h4>Voting Booth</h4>
            <p id="vote">You have voted for... You have to unlock your wallet first!</p>
            <p>Candidate</p>
            <select id="select">
                <option></option>
            </select>
            <button id="votebtc" disabled onclick="javascript:onClickVote()">Vote</button>
            <button id=refresh onclick="javascript:onClickRefresh()">Refresh</button>
        </div>
        <div id="loading">
            <p>Casting vote...</p>
        </div>

        <!-- All of these scripts are dependancies from the Nebulas Web Wallet -->
        <script src=lib/jquery-3.3.1.min.js></script>
        <script src=lib/nebulas.js></script>
        <script src=js/1-localSave.js></script>
        <script src=js/i18n.js data-depends=jquery.slim></script>
        <script src=js/ui-block.js data-depends="bootbox blockies jquery.slim i18n.js nebulas.js"></script>

        <!-- Front end logic for our Dapp -->
        <script>
            "use strict";

            // Global variables used by our Dapp
            var contract_address = 'n1tMib1B6gXBtgevvpWC5FqA98CjEG232Mn';
            var user_account = null;

            // Gas hard coded for simplicity, ideally your app would allow for changing the gas price, etc.
            var is_mainnet = true;
            var nebulas_chain_id, nebulas_domain;
            var gas_price = 1000000;
            var gas_limit = 200000;

            if(is_mainnet) {
                nebulas_chain_id = 1;
                nebulas_domain = 'https://mainnet.nebulas.io';
            } else {
                nebulas_chain_id = 1001;
                nebulas_domain = 'https://testnet.nebulas.io';
            }

            var nebulas = require('nebulas');
            var neb = new nebulas.Neb();
            neb.setRequest(new nebulas.HttpRequest(nebulas_domain));

            uiBlock.insert({
                selectWalletFile: ['.select-wallet-file', onUnlockFile]
            });

            function onClickRefresh() {
                neb.api.call({
                    from: contract_address,
                    to: contract_address,
                    value: 0,
                    nonce: 0,
                    gasPrice: gas_price,
                    gasLimit: gas_limit,
                    contract: {function: 'getVotes'}
                }).then(function (resp) {
                    var candidateMapping = JSON.parse(resp.result);
                    if(candidateMapping) {
                        var tbodyHtml = '';
                        var optionsHtml = '<option value="" selected disabled>Select candidate</option>';
                        Object.keys(candidateMapping).forEach(function (candidate) {
                            var tbody = '<tr>' +
                                '<td>' + candidate + '</td>' +
                                '<td>' + candidateMapping[candidate] + '</td>' +
                                '</tr>';
                            tbodyHtml += tbody;
                            optionsHtml += '<option>' + candidate + '</option>';
                        });
                        $('#tbody').empty().append(tbodyHtml);
                        $('#select').empty().append(optionsHtml);
                    }
                    if (user_account) {
                        neb.api.call({
                            from: user_account.getAddressString(),
                            to: contract_address,
                            value: 0,
                            nonce: 0,
                            gasPrice: gas_price,
                            gasLimit: gas_limit,
                            contract: {function: 'getMyVote'}
                        }).then(function (resp) {
                            var candidate = JSON.parse(resp.result);
                            $('#vote').empty().append('You have voted for: ' + candidate);
                        });
                    }
                });
            }

            $('#select').change(function () {
                if (!user_account) return;
                $('button').prop('disabled', this.value === 'Select candidate');
            });

            function onClickVote() {
                // Every transaction has a sequential ID, called 'Nonce'. Required to sign a message (but not for reading information)
                $('#loading').show();
                $('#main').hide();
                neb.api.getAccountState(user_account.getAddressString())
                    .then(function (resp) {
                        var nonce = parseInt(resp.nonce) + 1;
                        var gTx = new nebulas.Transaction(
                            nebulas_chain_id,
                            user_account,
                            contract_address,
                            0,
                            nonce,
                            gas_price,
                            gas_limit,
                            {function: "castVote", args: JSON.stringify([$('#select').val()]) });
                        gTx.signTransaction();
                        neb.api.sendRawTransaction(gTx.toProtoString())
                            .then(function () {
                                onClickRefresh();
                                $('#loading').hide();
                                $('#main').show();
                            });
                    });
            }

            function onUnlockFile(swf, fileJson, account, password) {
                account.fromKey(fileJson, password);
                user_account = account;
                var selectValue = $('#select').val();
                $('button').prop('disabled', !selectValue || selectValue === 'Select candidate');
                onClickRefresh();
            }

            onClickRefresh();
            $('#loading').hide();
        </script>
    </body>
</html>
